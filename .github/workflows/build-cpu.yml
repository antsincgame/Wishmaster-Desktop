# Build CPU-only version (no CUDA required)
# Smaller download, works on any system

name: Build Desktop Apps (CPU Only)

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to build'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - linux
          - windows
          - macos

env:
  CARGO_INCREMENTAL: 0
  CARGO_TERM_COLOR: always

jobs:
  build-linux-cpu:
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'linux' }}
    name: Build Linux (CPU)
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: src-tauri
      
    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libwebkit2gtk-4.1-dev \
          build-essential \
          cmake \
          curl \
          wget \
          libssl-dev \
          libgtk-3-dev \
          libayatana-appindicator3-dev \
          librsvg2-dev \
          imagemagick \
          libclang-dev \
          clang

    - name: Generate Linux icons
      run: |
        cd src-tauri/icons
        convert icon.png -resize 32x32 32x32.png
        convert icon.png -resize 128x128 128x128.png
        convert icon.png -resize 256x256 128x128@2x.png

    - name: Install npm dependencies
      run: npm ci

    - name: Build Tauri app (CPU only)
      run: |
        cd src-tauri
        cargo build --release --no-default-features --features "custom-protocol,llm-cpu"
        cd ..
        npm run tauri:build

    - name: Upload Linux AppImage (CPU)
      uses: actions/upload-artifact@v4
      with:
        name: wishmaster-linux-appimage-cpu
        path: src-tauri/target/release/bundle/appimage/*.AppImage

  build-windows-cpu:
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'windows' }}
    name: Build Windows (CPU)
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: src-tauri

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install LLVM/Clang
      uses: KyleMayes/install-llvm-action@v2
      with:
        version: "17"

    - name: Generate Windows icon
      run: |
        choco install imagemagick -y
        magick src-tauri/icons/icon.png -define icon:auto-resize=256,128,64,48,32,16 src-tauri/icons/icon.ico

    - name: Install npm dependencies
      run: npm ci

    - name: Build Tauri app (CPU only)
      run: |
        cd src-tauri
        cargo build --release --no-default-features --features "custom-protocol,llm-cpu"
        cd ..
        npm run tauri:build

    - name: Upload Windows MSI (CPU)
      uses: actions/upload-artifact@v4
      with:
        name: wishmaster-windows-msi-cpu
        path: src-tauri/target/release/bundle/msi/*.msi

  build-macos-cpu:
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'macos' }}
    name: Build macOS (CPU)
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-apple-darwin,x86_64-apple-darwin
      
    - name: Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: src-tauri

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install npm dependencies
      run: npm ci

    - name: Build Tauri app (Universal, CPU only)
      run: |
        cd src-tauri
        cargo build --release --no-default-features --features "custom-protocol,llm-cpu" --target aarch64-apple-darwin
        cargo build --release --no-default-features --features "custom-protocol,llm-cpu" --target x86_64-apple-darwin
        cd ..
        npm run tauri:build -- --target universal-apple-darwin

    - name: Upload macOS DMG (CPU)
      uses: actions/upload-artifact@v4
      with:
        name: wishmaster-macos-dmg-cpu
        path: src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg
        if-no-files-found: ignore
