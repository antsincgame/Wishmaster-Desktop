# Build with CUDA support for Linux and Windows

name: Build Desktop Apps (CUDA)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  CARGO_INCREMENTAL: 0
  CARGO_TERM_COLOR: always

jobs:
  # ==================== TESTS ====================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm test

  # ==================== LINUX + CUDA ====================
  build-linux:
    needs: test
    name: Build Linux (CUDA)
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4

    - name: Install CUDA Toolkit
      uses: Jimver/cuda-toolkit@v0.2.16
      id: cuda-toolkit
      with:
        cuda: '12.4.0'

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: src-tauri
      
    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libwebkit2gtk-4.1-dev \
          build-essential \
          cmake \
          curl \
          wget \
          libssl-dev \
          libgtk-3-dev \
          libayatana-appindicator3-dev \
          librsvg2-dev \
          imagemagick \
          libclang-dev \
          clang

    - name: Generate Linux icons
      run: |
        cd src-tauri/icons
        convert icon.png -resize 32x32 32x32.png
        convert icon.png -resize 128x128 128x128.png
        convert icon.png -resize 256x256 128x128@2x.png
        ls -la

    - name: Install npm dependencies
      run: npm ci

    - name: Build Tauri app
      run: npm run tauri:build
      env:
        CUDA_PATH: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}
        CMAKE_CUDA_ARCHITECTURES: "75;80;86;89"
        NO_STRIP: true
        APPIMAGE_EXTRACT_AND_RUN: 1

    - name: Upload Linux AppImage
      uses: actions/upload-artifact@v4
      with:
        name: wishmaster-linux-appimage-cuda
        path: src-tauri/target/release/bundle/appimage/*.AppImage
        
    - name: Upload Linux DEB
      uses: actions/upload-artifact@v4
      with:
        name: wishmaster-linux-deb-cuda
        path: src-tauri/target/release/bundle/deb/*.deb
        if-no-files-found: ignore

  # ==================== WINDOWS + CUDA ====================
  build-windows:
    needs: test
    name: Build Windows (CUDA)
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install CUDA Toolkit
      uses: Jimver/cuda-toolkit@v0.2.16
      id: cuda-toolkit
      with:
        cuda: '12.4.0'

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: src-tauri

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install LLVM/Clang
      uses: KyleMayes/install-llvm-action@v2
      with:
        version: "17"

    - name: Generate Windows icon
      run: |
        choco install imagemagick -y
        magick src-tauri/icons/icon.png -define icon:auto-resize=256,128,64,48,32,16 src-tauri/icons/icon.ico

    - name: Install npm dependencies
      run: npm ci

    - name: Build Tauri app
      run: npm run tauri:build
      env:
        CUDA_PATH: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}
        CMAKE_CUDA_ARCHITECTURES: "75;80;86;89"

    - name: Upload Windows MSI
      uses: actions/upload-artifact@v4
      with:
        name: wishmaster-windows-msi-cuda
        path: src-tauri/target/release/bundle/msi/*.msi

    - name: Upload Windows NSIS
      uses: actions/upload-artifact@v4
      with:
        name: wishmaster-windows-nsis-cuda
        path: src-tauri/target/release/bundle/nsis/*.exe
        if-no-files-found: ignore

  # ==================== RELEASE ====================
  release:
    name: Create GitHub Release
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: List artifacts
      run: ls -la */
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Wishmaster Desktop v${{ github.run_number }} (CUDA)
        body: |
          ## Wishmaster Desktop - GPU Accelerated
          
          ### Requirements
          - **NVIDIA GPU** with CUDA support
          - **CUDA Runtime** 12.x (bundled)
          
          ### Downloads
          - **Linux**: AppImage (recommended), DEB
          - **Windows**: MSI installer, NSIS installer  
          
          ### Features
          - üöÄ **GPU Acceleration** - CUDA for fast inference
          - üß† Total Memory System - AI remembers ALL conversations
          - ü™û Digital Twin Export - Create your own AI clone
          - üó£Ô∏è Voice Clone - TTS with your voice
          - üîí 100% Local - No cloud, no servers
          
        files: |
          wishmaster-linux-appimage-cuda/*
          wishmaster-linux-deb-cuda/*
          wishmaster-windows-msi-cuda/*
          wishmaster-windows-nsis-cuda/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
