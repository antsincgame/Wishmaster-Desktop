# Cross-platform build: Linux, Windows, macOS

name: Build Desktop Apps

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  CARGO_INCREMENTAL: 0
  CARGO_TERM_COLOR: always

jobs:
  # ==================== TESTS ====================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm test

  # ==================== LINUX ====================
  build-linux:
    needs: test
    name: Build Linux
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: src-tauri
      
    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libwebkit2gtk-4.1-dev \
          build-essential \
          cmake \
          curl \
          wget \
          libssl-dev \
          libgtk-3-dev \
          libayatana-appindicator3-dev \
          librsvg2-dev \
          imagemagick \
          icnsutils \
          libclang-dev \
          clang

    - name: Generate all icon formats
      run: |
        cd src-tauri/icons
        # Generate PNG sizes for Linux
        convert icon.png -resize 32x32 32x32.png
        convert icon.png -resize 128x128 128x128.png
        convert icon.png -resize 256x256 128x128@2x.png
        # Generate ICO for Windows
        convert icon.png -define icon:auto-resize=256,128,64,48,32,16 icon.ico
        # Generate ICNS for macOS
        mkdir -p icon.iconset
        convert icon.png -resize 16x16 icon.iconset/icon_16x16.png
        convert icon.png -resize 32x32 icon.iconset/icon_16x16@2x.png
        convert icon.png -resize 32x32 icon.iconset/icon_32x32.png
        convert icon.png -resize 64x64 icon.iconset/icon_32x32@2x.png
        convert icon.png -resize 128x128 icon.iconset/icon_128x128.png
        convert icon.png -resize 256x256 icon.iconset/icon_128x128@2x.png
        convert icon.png -resize 256x256 icon.iconset/icon_256x256.png
        convert icon.png -resize 512x512 icon.iconset/icon_256x256@2x.png
        convert icon.png -resize 512x512 icon.iconset/icon_512x512.png
        convert icon.png -resize 1024x1024 icon.iconset/icon_512x512@2x.png
        png2icns icon.icns icon.iconset/*.png 2>/dev/null || true
        ls -la

    - name: Install npm dependencies
      run: npm ci

    - name: Build Tauri app
      run: npm run tauri:build

    - name: Upload Linux AppImage
      uses: actions/upload-artifact@v4
      with:
        name: wishmaster-linux-appimage
        path: src-tauri/target/release/bundle/appimage/*.AppImage
        
    - name: Upload Linux DEB
      uses: actions/upload-artifact@v4
      with:
        name: wishmaster-linux-deb
        path: src-tauri/target/release/bundle/deb/*.deb
        if-no-files-found: ignore

  # ==================== WINDOWS ====================
  build-windows:
    needs: test
    name: Build Windows
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: src-tauri

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install LLVM/Clang (for llama.cpp)
      uses: KyleMayes/install-llvm-action@v2
      with:
        version: "17"

    - name: Generate Windows icon
      run: |
        choco install imagemagick -y
        magick src-tauri/icons/icon.png -define icon:auto-resize=256,128,64,48,32,16 src-tauri/icons/icon.ico

    - name: Install npm dependencies
      run: npm ci

    - name: Build Tauri app
      run: npm run tauri:build

    - name: Upload Windows MSI
      uses: actions/upload-artifact@v4
      with:
        name: wishmaster-windows-msi
        path: src-tauri/target/release/bundle/msi/*.msi

    - name: Upload Windows NSIS
      uses: actions/upload-artifact@v4
      with:
        name: wishmaster-windows-nsis
        path: src-tauri/target/release/bundle/nsis/*.exe
        if-no-files-found: ignore

  # ==================== macOS ====================
  build-macos:
    needs: test
    name: Build macOS
    runs-on: macos-latest
    env:
      MACOSX_DEPLOYMENT_TARGET: "10.15"
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: src-tauri

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Generate macOS icons
      run: |
        # Generate .icns
        mkdir -p src-tauri/icons/icon.iconset
        sips -z 16 16 src-tauri/icons/icon.png --out src-tauri/icons/icon.iconset/icon_16x16.png
        sips -z 32 32 src-tauri/icons/icon.png --out src-tauri/icons/icon.iconset/icon_16x16@2x.png
        sips -z 32 32 src-tauri/icons/icon.png --out src-tauri/icons/icon.iconset/icon_32x32.png
        sips -z 64 64 src-tauri/icons/icon.png --out src-tauri/icons/icon.iconset/icon_32x32@2x.png
        sips -z 128 128 src-tauri/icons/icon.png --out src-tauri/icons/icon.iconset/icon_128x128.png
        sips -z 256 256 src-tauri/icons/icon.png --out src-tauri/icons/icon.iconset/icon_128x128@2x.png
        sips -z 256 256 src-tauri/icons/icon.png --out src-tauri/icons/icon.iconset/icon_256x256.png
        sips -z 512 512 src-tauri/icons/icon.png --out src-tauri/icons/icon.iconset/icon_256x256@2x.png
        sips -z 512 512 src-tauri/icons/icon.png --out src-tauri/icons/icon.iconset/icon_512x512.png
        sips -z 1024 1024 src-tauri/icons/icon.png --out src-tauri/icons/icon.iconset/icon_512x512@2x.png
        iconutil -c icns src-tauri/icons/icon.iconset -o src-tauri/icons/icon.icns
        # Generate .ico (needed by Tauri bundler)
        brew install imagemagick
        convert src-tauri/icons/icon.png -define icon:auto-resize=256,128,64,48,32,16 src-tauri/icons/icon.ico

    - name: Install npm dependencies
      run: npm ci

    - name: Build Tauri app
      run: npm run tauri:build

    - name: Upload macOS DMG
      uses: actions/upload-artifact@v4
      with:
        name: wishmaster-macos-dmg
        path: src-tauri/target/release/bundle/dmg/*.dmg

    - name: Upload macOS App
      uses: actions/upload-artifact@v4
      with:
        name: wishmaster-macos-app
        path: src-tauri/target/release/bundle/macos/*.app
        if-no-files-found: ignore

  # ==================== RELEASE ====================
  release:
    name: Create GitHub Release
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: List artifacts
      run: ls -la */
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Wishmaster Desktop v${{ github.run_number }}
        body: |
          ## Wishmaster Desktop
          
          ### Downloads
          - **Linux**: AppImage (recommended), DEB
          - **Windows**: MSI installer, NSIS installer  
          - **macOS**: DMG
          
          ### Features
          - üß† Total Memory System - AI remembers ALL conversations
          - ü™û Digital Twin Export - Create your own AI clone
          - üó£Ô∏è Voice Clone - TTS with your voice
          - üîí 100% Local - No cloud, no servers
          
        files: |
          wishmaster-linux-appimage/*
          wishmaster-linux-deb/*
          wishmaster-windows-msi/*
          wishmaster-windows-nsis/*
          wishmaster-macos-dmg/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
