# Build Wishmaster Desktop for Linux (DEB, RPM, AppImage)
name: Build Linux

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  CARGO_INCREMENTAL: 0
  CARGO_TERM_COLOR: always

jobs:
  # Job 1: Build DEB and RPM on Ubuntu 24.04 (with embeddings feature)
  build-linux-packages:
    name: Build Linux DEB/RPM
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libwebkit2gtk-4.1-dev \
          build-essential \
          curl \
          wget \
          file \
          libxdo-dev \
          libssl-dev \
          libayatana-appindicator3-dev \
          librsvg2-dev \
          libsqlite3-dev \
          pkg-config

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: src-tauri
        cache-on-failure: true

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install npm dependencies
      run: npm ci

    # ==================== VALIDATION STAGE ====================
    - name: Check Tauri versions sync
      run: npm run check:tauri-versions

    - name: Validate configuration
      run: npm run validate

    - name: TypeScript type check
      run: npm run typecheck

    - name: Run frontend tests
      run: npm test

    # ==================== BUILD STAGE ====================
    - name: Build frontend
      run: npm run build

    - name: Rust syntax check
      working-directory: src-tauri
      run: cargo check

    - name: Build Tauri DEB and RPM
      run: npx tauri build --bundles deb,rpm

    - name: List build output
      run: |
        echo "=== Bundle directory ==="
        find src-tauri/target/release/bundle -type f \( -name "*.deb" -o -name "*.rpm" \) 2>/dev/null | while read f; do ls -lh "$f"; done || echo "No packages found"

    - name: Upload Linux DEB
      uses: actions/upload-artifact@v4
      with:
        name: wishmaster-linux-deb
        path: src-tauri/target/release/bundle/deb/*.deb
        if-no-files-found: warn

    - name: Upload Linux RPM
      uses: actions/upload-artifact@v4
      with:
        name: wishmaster-linux-rpm
        path: src-tauri/target/release/bundle/rpm/*.rpm
        if-no-files-found: warn

  # Job 2: Build AppImage on Ubuntu 22.04 (native runner)
  # Ubuntu 22.04 is minimum for Tauri 2.x (requires libwebkit2gtk-4.1)
  # glibc 2.35 provides good compatibility with most modern Linux distros
  build-linux-appimage:
    name: Build Linux AppImage
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libwebkit2gtk-4.1-dev \
          build-essential \
          curl \
          wget \
          file \
          libxdo-dev \
          libssl-dev \
          libayatana-appindicator3-dev \
          librsvg2-dev \
          libsqlite3-dev \
          pkg-config \
          libfuse2 \
          libclang-dev \
          clang \
          cmake

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: src-tauri
        cache-on-failure: true
        # Different cache key for AppImage build (no embeddings)
        prefix-key: "v0-rust-appimage"

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install npm dependencies
      run: npm ci

    - name: Build frontend
      run: npm run build

    - name: Setup linuxdeploy for extraction mode
      run: |
        # Download linuxdeploy and extract it to avoid FUSE/glibc issues
        mkdir -p ~/.cache/tauri
        
        # Download linuxdeploy
        wget -q "https://github.com/tauri-apps/binary-releases/releases/download/linuxdeploy/linuxdeploy-x86_64.AppImage" \
          -O ~/.cache/tauri/linuxdeploy-x86_64.AppImage
        chmod +x ~/.cache/tauri/linuxdeploy-x86_64.AppImage
        
        # Extract linuxdeploy (avoids FUSE requirement)
        cd ~/.cache/tauri
        ./linuxdeploy-x86_64.AppImage --appimage-extract
        
        # Create wrapper script that uses extracted version
        cat > linuxdeploy-wrapper << 'EOF'
        #!/bin/bash
        exec ~/.cache/tauri/squashfs-root/AppRun "$@"
        EOF
        chmod +x linuxdeploy-wrapper
        
        # Download and extract plugin-appimage
        wget -q "https://github.com/linuxdeploy/linuxdeploy-plugin-appimage/releases/download/continuous/linuxdeploy-plugin-appimage-x86_64.AppImage" \
          -O linuxdeploy-plugin-appimage-x86_64.AppImage
        chmod +x linuxdeploy-plugin-appimage-x86_64.AppImage
        ./linuxdeploy-plugin-appimage-x86_64.AppImage --appimage-extract
        mv squashfs-root squashfs-root-plugin
        
        echo "linuxdeploy extracted successfully"
        ls -la ~/.cache/tauri/

    - name: Build Tauri AppImage
      run: |
        npx tauri build --bundles appimage -- --no-default-features --features custom-protocol
      env:
        # Disable strip to avoid .relr.dyn section errors with modern glibc
        NO_STRIP: "true"
        # Force linuxdeploy to extract instead of mount
        APPIMAGE_EXTRACT_AND_RUN: "1"
        # No signing for now
        TAURI_SIGNING_PRIVATE_KEY: ""

    - name: List AppImage output
      run: |
        echo "=== AppImage directory ==="
        find src-tauri/target/release/bundle -type f -name "*.AppImage" 2>/dev/null | while read f; do ls -lh "$f"; done || echo "No AppImage found"

    - name: Upload Linux AppImage
      uses: actions/upload-artifact@v4
      with:
        name: wishmaster-linux-appimage
        path: src-tauri/target/release/bundle/appimage/*.AppImage
        if-no-files-found: warn
