# Build Wishmaster Desktop for Linux (DEB, RPM, AppImage)
name: Build Linux

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  CARGO_INCREMENTAL: 0
  CARGO_TERM_COLOR: always

jobs:
  # Job 1: Build DEB and RPM on Ubuntu 24.04 (native, fast)
  build-linux-packages:
    name: Build Linux DEB/RPM
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libwebkit2gtk-4.1-dev \
          build-essential \
          curl \
          wget \
          file \
          libxdo-dev \
          libssl-dev \
          libayatana-appindicator3-dev \
          librsvg2-dev \
          libsqlite3-dev \
          pkg-config

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: src-tauri
        cache-on-failure: true

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install npm dependencies
      run: npm ci

    # ==================== VALIDATION STAGE ====================
    - name: Check Tauri versions sync
      run: npm run check:tauri-versions

    - name: Validate configuration
      run: npm run validate

    - name: TypeScript type check
      run: npm run typecheck

    - name: Run frontend tests
      run: npm test

    # ==================== BUILD STAGE ====================
    - name: Build frontend
      run: npm run build

    - name: Rust syntax check
      working-directory: src-tauri
      run: cargo check --features "custom-protocol"

    - name: Build Tauri DEB and RPM
      run: npx tauri build --bundles deb,rpm

    - name: List build output
      run: |
        echo "=== Bundle directory ==="
        find src-tauri/target/release/bundle -name "*.deb" -o -name "*.rpm" 2>/dev/null | xargs ls -lh || echo "No packages found"

    - name: Upload Linux DEB
      uses: actions/upload-artifact@v4
      with:
        name: wishmaster-linux-deb
        path: src-tauri/target/release/bundle/deb/*.deb
        if-no-files-found: warn

    - name: Upload Linux RPM
      uses: actions/upload-artifact@v4
      with:
        name: wishmaster-linux-rpm
        path: src-tauri/target/release/bundle/rpm/*.rpm
        if-no-files-found: warn

  # Job 2: Build AppImage using Docker with Ubuntu 22.04
  # Use custom linuxdeploy build for glibc compatibility
  build-linux-appimage:
    name: Build Linux AppImage
    runs-on: ubuntu-24.04
    container:
      image: ubuntu:22.04
      options: --privileged
      env:
        DEBIAN_FRONTEND: noninteractive
    steps:
    - name: Install git and dependencies
      run: |
        apt-get update
        apt-get install -y git curl wget sudo

    - name: Checkout
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        apt-get install -y \
          libwebkit2gtk-4.1-dev \
          build-essential \
          file \
          libxdo-dev \
          libssl-dev \
          libayatana-appindicator3-dev \
          librsvg2-dev \
          libsqlite3-dev \
          pkg-config \
          libfuse2 \
          patchelf \
          ca-certificates \
          libclang-dev \
          clang \
          cmake \
          squashfs-tools

    - name: Install Rust
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Install Node.js
      run: |
        curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
        apt-get install -y nodejs

    - name: Install npm dependencies
      run: npm ci

    - name: Build frontend
      run: npm run build

    - name: Build Rust binary
      run: |
        export PATH="$HOME/.cargo/bin:$PATH"
        # Build without embeddings feature for glibc 2.35 compatibility
        cd src-tauri && cargo build --release --no-default-features --features custom-protocol

    - name: Create AppImage manually
      run: |
        # Create AppImage structure manually to avoid linuxdeploy glibc issues
        APP_NAME="Wishmaster Desktop"
        APP_DIR="AppDir"
        
        # Create AppDir structure
        mkdir -p "$APP_DIR/usr/bin"
        mkdir -p "$APP_DIR/usr/share/applications"
        mkdir -p "$APP_DIR/usr/share/icons/hicolor/256x256/apps"
        
        # Copy binary
        cp src-tauri/target/release/wishmaster-desktop "$APP_DIR/usr/bin/"
        
        # Create desktop file
        cat > "$APP_DIR/usr/share/applications/wishmaster-desktop.desktop" << 'DESKTOP'
        [Desktop Entry]
        Name=Wishmaster Desktop
        Exec=wishmaster-desktop
        Icon=wishmaster-desktop
        Type=Application
        Categories=Utility;
        Comment=Local AI Assistant with Voice Cloning
        DESKTOP
        
        # Copy icon
        cp src-tauri/icons/icon.png "$APP_DIR/usr/share/icons/hicolor/256x256/apps/wishmaster-desktop.png"
        
        # Create AppRun
        cat > "$APP_DIR/AppRun" << 'APPRUN'
        #!/bin/bash
        HERE="$(dirname "$(readlink -f "${0}")")"
        export PATH="${HERE}/usr/bin:${PATH}"
        export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
        exec "${HERE}/usr/bin/wishmaster-desktop" "$@"
        APPRUN
        chmod +x "$APP_DIR/AppRun"
        
        # Create symlinks for AppImage
        ln -sf usr/share/applications/wishmaster-desktop.desktop "$APP_DIR/wishmaster-desktop.desktop"
        ln -sf usr/share/icons/hicolor/256x256/apps/wishmaster-desktop.png "$APP_DIR/wishmaster-desktop.png"
        ln -sf usr/share/icons/hicolor/256x256/apps/wishmaster-desktop.png "$APP_DIR/.DirIcon"
        
        # Download appimagetool (static binary, no glibc issues)
        wget -q "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage" -O appimagetool
        chmod +x appimagetool
        
        # Extract appimagetool (avoid FUSE issues in container)
        ./appimagetool --appimage-extract
        
        # Create AppImage
        mkdir -p src-tauri/target/release/bundle/appimage
        ARCH=x86_64 ./squashfs-root/AppRun "$APP_DIR" "src-tauri/target/release/bundle/appimage/Wishmaster_Desktop_1.0.0_amd64.AppImage"
        
        echo "=== AppImage created ==="
        ls -la src-tauri/target/release/bundle/appimage/

    - name: List AppImage output
      run: |
        echo "=== AppImage directory ==="
        find src-tauri/target/release/bundle -name "*.AppImage" 2>/dev/null | xargs ls -lh || echo "No AppImage found"

    - name: Upload Linux AppImage
      uses: actions/upload-artifact@v4
      with:
        name: wishmaster-linux-appimage
        path: src-tauri/target/release/bundle/appimage/*.AppImage
        if-no-files-found: warn
